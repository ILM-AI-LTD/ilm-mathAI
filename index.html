<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Math Evaluation System</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 8px;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--light-color);
            color: var(--dark-color);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: var(--dark-color);
            text-align: center;
            margin-bottom: 2rem;
        }

        .card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-sizing: border-box;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .file-upload-wrapper {
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-upload-wrapper:hover {
            background-color: #e9ecef;
        }
        .file-upload-wrapper p {
            margin: 0;
            font-weight: 500;
            color: var(--secondary-color);
        }

        input[type="file"] {
            display: none;
        }
        
        #image-preview {
            max-width: 100%;
            max-height: 300px;
            margin-top: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #dee2e6;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
            background-color: var(--primary-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #0056b3;
        }
        
        .btn:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }

        #results {
            margin-top: 2rem;
        }

        .result-box {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .result-box h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        
        .result-box pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: var(--light-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            font-family: monospace;
        }
        
        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .spinner {
            display: none; /* Hidden by default */
            margin: 2rem auto;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 123, 255, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ðŸ§  AI Math Evaluation System</h1>

        <div class="card">
            <form id="eval-form">
                <div class="form-group">
                    <label for="question">Math Question</label>
                    <textarea id="question" name="question" placeholder="e.g., Solve for x: 2x + 5 = 15" required></textarea>
                </div>

                <div class="form-group">
                    <label for="correct-answer">Correct Answer</label>
                    <input type="text" id="correct-answer" name="correct_answer" placeholder="e.g., x = 5" required>
                </div>

                <div class="form-group">
                    <label for="student-work">Upload Student's Handwritten Work</label>
                    <label for="student-work-image" class="file-upload-wrapper">
                        <p id="file-upload-text">Click or drag image here</p>
                    </label>
                    <input type="file" id="student-work-image" accept="image/png, image/jpeg, image/webp" required>
                    <img id="image-preview" src="" alt="Image preview" style="display: none;">
                </div>

                <button type="submit" id="submit-btn" class="btn">Evaluate</button>
            </form>
        </div>

        <div id="loading-spinner" class="spinner"></div>

        <div id="error-message"></div>

        <div id="results" style="display: none;">
            <div class="result-box">
                <h3>ðŸ¤– Extracted Text (OCR)</h3>
                <pre id="ocr-text"></pre>
            </div>
            <div class="result-box">
                <h3>ðŸ’¡ AI Feedback & Hints</h3>
                <div id="evaluation-text"></div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('eval-form');
        const questionInput = document.getElementById('question');
        const correctAnswerInput = document.getElementById('correct-answer');
        const imageInput = document.getElementById('student-work-image');
        const imagePreview = document.getElementById('image-preview');
        const fileUploadText = document.getElementById('file-upload-text');
        const submitBtn = document.getElementById('submit-btn');
        const spinner = document.getElementById('loading-spinner');
        const resultsDiv = document.getElementById('results');
        const ocrTextElem = document.getElementById('ocr-text');
        const evaluationTextElem = document.getElementById('evaluation-text');
        const errorMessageDiv = document.getElementById('error-message');
    
        // Handle image preview
        imageInput.addEventListener('change', () => {
            const file = imageInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    fileUploadText.textContent = `File selected: ${file.name}`;
                };
                reader.readAsDataURL(file);
            }
        });
    
        // Handle form submission
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
    
            // Reset UI
            submitBtn.disabled = true;
            submitBtn.textContent = 'Evaluating...';
            spinner.style.display = 'block';
            resultsDiv.style.display = 'none';
            errorMessageDiv.innerHTML = '';
            
            const file = imageInput.files[0];
            if (!file) {
                showError('Please select an image file.');
                resetButton();
                return;
            }
    
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Image = reader.result;
    
                const payload = {
                    question: questionInput.value,
                    correct_answer: correctAnswerInput.value,
                    image: base64Image
                };
    
                try {
                    // âœ… **URL has been updated here**
                    const response = await fetch('http://127.0.0.1:5000/api/full_evaluation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
    
                    const data = await response.json();
    
                    if (!response.ok || !data.success) {
                        throw new Error(data.error || 'An unknown error occurred.');
                    }
    
                    // Display results
                    ocrTextElem.textContent = data.extracted_text || 'No text extracted.';
                    evaluationTextElem.innerHTML = data.evaluation.replace(/\n/g, '<br>');
                    resultsDiv.style.display = 'block';
    
                } catch (error) {
                    console.error('Evaluation Error:', error);
                    showError(`Error: ${error.message}`);
                } finally {
                    resetButton();
                }
            };
            
            reader.onerror = (error) => {
                console.error('File Reading Error:', error);
                showError('Failed to read the image file.');
                resetButton();
            };
        });
    
        function showError(message) {
            errorMessageDiv.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }
    
        function resetButton() {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Evaluate';
            spinner.style.display = 'none';
        }
    </script>
</body>
</html>